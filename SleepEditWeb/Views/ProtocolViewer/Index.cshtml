@using SleepEditWeb.Models
@model ProtocolViewerViewModel
@{
    ViewData["Title"] = "Protocol Viewer";
    var isEmbedded = string.Equals(Context.Request.Query["embed"], "1", StringComparison.Ordinal);
}

<div class="protocol-viewer-page @(isEmbedded ? "protocol-viewer-page-embedded" : string.Empty)">
    <div class="page-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
            <h1 class="page-title">Protocol Viewer</h1>
            <p class="page-subtitle">Select protocol items and insert them into the tech note.</p>
        </div>
        <div class="d-flex flex-wrap gap-2 protocol-viewer-menu">
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Tech Name
                </button>
                <ul class="dropdown-menu">
                    <li><button type="button" class="dropdown-item" id="addTechNameBtn">Add</button></li>
                    <li><button type="button" class="dropdown-item" id="removeTechNameBtn">Remove</button></li>
                    <li><button type="button" class="dropdown-item text-danger" id="clearTechNameBtn">Clear List</button></li>
                </ul>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Mask Style
                </button>
                <ul class="dropdown-menu">
                    <li><button type="button" class="dropdown-item" id="addMaskStyleBtn">Add</button></li>
                    <li><button type="button" class="dropdown-item" id="removeMaskStyleBtn">Remove</button></li>
                    <li><button type="button" class="dropdown-item text-danger" id="clearMaskStyleBtn">Clear List</button></li>
                </ul>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    Mask Size
                </button>
                <ul class="dropdown-menu">
                    <li><button type="button" class="dropdown-item" id="addMaskSizeBtn">Add</button></li>
                    <li><button type="button" class="dropdown-item" id="removeMaskSizeBtn">Remove</button></li>
                    <li><button type="button" class="dropdown-item text-danger" id="clearMaskSizeBtn">Clear List</button></li>
                </ul>
            </div>
            <button type="button" class="btn btn-outline-secondary" id="toggleSelectAllBtn">Toggle Select All</button>
            <select id="gotoSectionSelect" class="form-select protocol-viewer-goto">
                <option value="study">GOTO Section</option>
                @foreach (var protocolSection in Model.InitialDocument.Sections)
                {
                    <option value="section-@protocolSection.Id">@protocolSection.Text</option>
                }
            </select>
        </div>
    </div>

    <div class="d-flex gap-2 mb-3">
        <button type="button" class="btn btn-primary" id="protocolViewerOkBtn">OK</button>
        <button type="button" class="btn btn-outline-secondary" id="protocolViewerCancelBtn">Cancel</button>
    </div>

    <ul class="nav nav-tabs protocol-viewer-tabs" id="protocolViewerTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="protocol-tab-study" data-bs-toggle="tab" data-bs-target="#protocol-pane-study" type="button" role="tab" aria-controls="protocol-pane-study" aria-selected="true" data-tab-key="study">StudyInfo</button>
        </li>
        @foreach (var protocolSection in Model.InitialDocument.Sections)
        {
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="protocol-tab-section-@protocolSection.Id" data-bs-toggle="tab" data-bs-target="#protocol-pane-section-@protocolSection.Id" type="button" role="tab" aria-controls="protocol-pane-section-@protocolSection.Id" aria-selected="false" data-tab-key="section-@protocolSection.Id">@protocolSection.Text</button>
            </li>
        }
    </ul>

    <div class="tab-content protocol-viewer-content" id="protocolViewerTabContent">
        <div class="tab-pane fade show active" id="protocol-pane-study" role="tabpanel" aria-labelledby="protocol-tab-study" tabindex="0">
            <div class="row g-3 mt-1">
                <div class="col-12 col-xl-6">
                    <div class="dashboard-card h-100">
                        <div class="dashboard-card-header">
                            <i class="bi bi-person-vcard me-2"></i>StudyInfo
                        </div>
                        <div class="dashboard-card-body">
                            <div class="mb-3">
                                <label for="studyTechName" class="form-label">Technician</label>
                                <select id="studyTechName" class="form-select"></select>
                            </div>
                            <div class="mb-3">
                                <label for="studyDate" class="form-label">Date of Study</label>
                                <input id="studyDate" type="date" class="form-control" />
                            </div>
                            <div class="mb-0">
                                <label for="patientName" class="form-label">Patient Name</label>
                                <input id="patientName" type="text" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-6">
                    <div class="dashboard-card h-100">
                        <div class="dashboard-card-header">
                            <i class="bi bi-wind me-2"></i>CPAP/BIPAP Info
                        </div>
                        <div class="dashboard-card-body">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="cpapNoUnit" />
                                <label class="form-check-label" for="cpapNoUnit">Pt does not have a CPAP/BiPAP unit.</label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="cpapNoBring" />
                                <label class="form-check-label" for="cpapNoBring">Pt has machine but did not bring it.</label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="cpapHasMachine" />
                                <label class="form-check-label" for="cpapHasMachine">Pt has and brought a CPAP/BiPAP.</label>
                            </div>
                            <div class="row g-2">
                                <div class="col-12 col-md-6">
                                    <label for="maskStyleSelect" class="form-label">Mask Style</label>
                                    <select id="maskStyleSelect" class="form-select"></select>
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="maskSizeSelect" class="form-label">Mask Size</label>
                                    <select id="maskSizeSelect" class="form-select"></select>
                                </div>
                            </div>
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="cpapHeatedHumidity" />
                                <label class="form-check-label" for="cpapHeatedHumidity">Heated Humidifier</label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="cpapChinStrap" />
                                <label class="form-check-label" for="cpapChinStrap">Chin Strap</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-xl-6">
                    <div class="dashboard-card">
                        <div class="dashboard-card-header">
                            <i class="bi bi-droplet-half me-2"></i>Oxygen Info
                        </div>
                        <div class="dashboard-card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="arrivedOnO2" />
                                <label class="form-check-label" for="arrivedOnO2">Pt arrived on O2</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        @foreach (var protocolSection in Model.InitialDocument.Sections)
        {
            <div class="tab-pane fade" id="protocol-pane-section-@protocolSection.Id" role="tabpanel" aria-labelledby="protocol-tab-section-@protocolSection.Id" tabindex="0">
                <div class="dashboard-card mt-2">
                    <div class="dashboard-card-header">
                        <i class="bi bi-list-check me-2"></i>@protocolSection.Text
                    </div>
                    <div class="dashboard-card-body">
                        <div class="protocol-node-host" data-section-id="@protocolSection.Id"></div>
                    </div>
                </div>
            </div>
        }
    </div>

    <div id="protocolViewerStatus" class="small text-muted mt-2">Ready</div>
</div>

@section Scripts {
<script>
    (function() {
        const documentModel = @Html.Raw(Json.Serialize(Model.InitialDocument));
        const initialTechNames = @Html.Raw(Json.Serialize(Model.InitialTechNames));
        const initialMaskStyles = @Html.Raw(Json.Serialize(Model.InitialMaskStyles));
        const initialMaskSizes = @Html.Raw(Json.Serialize(Model.InitialMaskSizes));
        const initialStudyDate = @Html.Raw(Json.Serialize(Model.InitialStudyDate));

        const storageKeys = {
            techNames: 'protocolViewer.techNames',
            maskStyles: 'protocolViewer.maskStyles',
            maskSizes: 'protocolViewer.maskSizes'
        };

        const nodeLookup = new Map();
        const parentLookup = new Map();
        const sectionLookup = new Map();
        const subTextSelections = new Map();
        const checkedNodeIds = new Set();

        const statusEl = document.getElementById('protocolViewerStatus');
        const gotoSectionSelect = document.getElementById('gotoSectionSelect');
        const techSelect = document.getElementById('studyTechName');
        const studyDateInput = document.getElementById('studyDate');
        const patientNameInput = document.getElementById('patientName');
        const maskStyleSelect = document.getElementById('maskStyleSelect');
        const maskSizeSelect = document.getElementById('maskSizeSelect');

        let techNames = loadList(storageKeys.techNames, initialTechNames);
        let maskStyles = loadList(storageKeys.maskStyles, initialMaskStyles);
        let maskSizes = loadList(storageKeys.maskSizes, initialMaskSizes);

        initialize();

        function initialize() {
            buildNodeMaps(documentModel.sections, null, null);
            renderAllSections();
            refreshLookupSelects();
            bindEvents();
            studyDateInput.value = toDateInputValue(initialStudyDate);
            setStatus('Ready');
        }

        function bindEvents() {
            document.getElementById('addTechNameBtn').addEventListener('click', () => addLookupValue('Tech Name', techNames, storageKeys.techNames, refreshLookupSelects));
            document.getElementById('removeTechNameBtn').addEventListener('click', () => removeLookupValue('Tech Name', techNames, storageKeys.techNames, refreshLookupSelects));
            document.getElementById('clearTechNameBtn').addEventListener('click', () => clearLookupValues('Tech Name', techNames, storageKeys.techNames, refreshLookupSelects));

            document.getElementById('addMaskStyleBtn').addEventListener('click', () => addLookupValue('Mask Style', maskStyles, storageKeys.maskStyles, refreshLookupSelects));
            document.getElementById('removeMaskStyleBtn').addEventListener('click', () => removeLookupValue('Mask Style', maskStyles, storageKeys.maskStyles, refreshLookupSelects));
            document.getElementById('clearMaskStyleBtn').addEventListener('click', () => clearLookupValues('Mask Style', maskStyles, storageKeys.maskStyles, refreshLookupSelects));

            document.getElementById('addMaskSizeBtn').addEventListener('click', () => addLookupValue('Mask Size', maskSizes, storageKeys.maskSizes, refreshLookupSelects));
            document.getElementById('removeMaskSizeBtn').addEventListener('click', () => removeLookupValue('Mask Size', maskSizes, storageKeys.maskSizes, refreshLookupSelects));
            document.getElementById('clearMaskSizeBtn').addEventListener('click', () => clearLookupValues('Mask Size', maskSizes, storageKeys.maskSizes, refreshLookupSelects));

            document.getElementById('toggleSelectAllBtn').addEventListener('click', toggleSelectAllNodes);
            gotoSectionSelect.addEventListener('change', onGotoSectionChanged);
            document.getElementById('protocolViewerOkBtn').addEventListener('click', onOk);
            document.getElementById('protocolViewerCancelBtn').addEventListener('click', onCancel);
        }

        function buildNodeMaps(nodes, parentId, sectionId) {
            nodes.forEach(node => {
                const effectiveSectionId = sectionId ?? node.id;
                nodeLookup.set(node.id, node);
                parentLookup.set(node.id, parentId);
                sectionLookup.set(node.id, effectiveSectionId);

                (node.children || []).forEach(child => {
                    buildNodeMaps([child], node.id, effectiveSectionId);
                });
            });
        }

        function renderAllSections() {
            documentModel.sections.forEach(section => {
                const host = document.querySelector(`[data-section-id="${section.id}"]`);
                if (!host) {
                    return;
                }

                host.innerHTML = '';
                (section.children || []).forEach(node => {
                    host.appendChild(buildNodeRow(node, 0));
                });
            });
        }

        function buildNodeRow(node, depth) {
            const row = document.createElement('div');
            row.className = 'protocol-node-row';
            row.dataset.nodeId = String(node.id);
            row.style.paddingLeft = `${depth * 24}px`;

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input protocol-node-checkbox';
            checkbox.id = `protocol-node-${node.id}`;
            checkbox.addEventListener('change', () => onNodeCheckedChanged(node.id, checkbox.checked));

            const label = document.createElement('label');
            label.className = 'protocol-node-label';
            label.setAttribute('for', checkbox.id);
            label.textContent = node.text || '(empty)';

            row.appendChild(checkbox);
            row.appendChild(label);

            if ((node.subText || []).length > 0) {
                row.appendChild(buildSubTextSelect(node));
            }

            if (hasLink(node)) {
                row.appendChild(buildNodeLink(node));
            }

            const container = document.createElement('div');
            container.className = 'protocol-node-container';
            container.appendChild(row);

            (node.children || []).forEach(child => {
                container.appendChild(buildNodeRow(child, depth + 1));
            });

            return container;
        }

        function buildSubTextSelect(node) {
            const select = document.createElement('select');
            select.className = 'form-select form-select-sm protocol-node-subtext';
            const empty = document.createElement('option');
            empty.value = '';
            empty.textContent = '';
            select.appendChild(empty);

            (node.subText || []).forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });

            select.addEventListener('change', () => {
                if (!select.value) {
                    subTextSelections.delete(node.id);
                    return;
                }

                subTextSelections.set(node.id, select.value);
            });

            return select;
        }

        function buildNodeLink(node) {
            const link = document.createElement('button');
            link.type = 'button';
            link.className = 'btn btn-link p-0 protocol-viewer-link';
            link.textContent = node.linkText;
            link.addEventListener('click', () => gotoLinkedNode(node.linkId));
            return link;
        }

        function hasLink(node) {
            return Number(node.linkId) > 0 && !!node.linkText;
        }

        function onNodeCheckedChanged(nodeId, isChecked) {
            updateCheckedSet(nodeId, isChecked);
            if (isChecked) {
                checkAncestors(nodeId);
            }
        }

        function updateCheckedSet(nodeId, isChecked) {
            if (isChecked) {
                checkedNodeIds.add(nodeId);
                return;
            }

            checkedNodeIds.delete(nodeId);
        }

        function checkAncestors(nodeId) {
            let current = parentLookup.get(nodeId);
            while (current != null) {
                checkedNodeIds.add(current);
                const ancestorCheckbox = document.getElementById(`protocol-node-${current}`);
                if (ancestorCheckbox) {
                    ancestorCheckbox.checked = true;
                }

                current = parentLookup.get(current);
            }
        }

        function toggleSelectAllNodes() {
            const checkboxes = document.querySelectorAll('.protocol-node-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = !checkbox.checked;
                const nodeId = Number(checkbox.id.replace('protocol-node-', ''));
                updateCheckedSet(nodeId, checkbox.checked);
            });
        }

        function onGotoSectionChanged() {
            const tabKey = gotoSectionSelect.value;
            if (!tabKey) {
                return;
            }

            showTab(tabKey);
        }

        function showTab(tabKey) {
            const button = document.querySelector(`[data-tab-key="${tabKey}"]`);
            if (!button) {
                return;
            }

            const tab = bootstrap.Tab.getOrCreateInstance(button);
            tab.show();
        }

        function gotoLinkedNode(linkId) {
            if (!nodeLookup.has(linkId)) {
                setStatus(`Linked node #${linkId} was not found.`);
                return;
            }

            const sectionId = sectionLookup.get(linkId);
            showTab(`section-${sectionId}`);
            highlightLinkedNode(linkId);
        }

        function highlightLinkedNode(nodeId) {
            const nodeRow = document.querySelector(`[data-node-id="${nodeId}"]`);
            if (!nodeRow) {
                return;
            }

            nodeRow.classList.add('protocol-node-highlight');
            nodeRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            window.setTimeout(() => nodeRow.classList.remove('protocol-node-highlight'), 2000);
        }

        function refreshLookupSelects() {
            bindSelectOptions(techSelect, techNames);
            bindSelectOptions(maskStyleSelect, maskStyles);
            bindSelectOptions(maskSizeSelect, maskSizes);
        }

        function bindSelectOptions(select, values) {
            const previous = select.value;
            select.innerHTML = '';

            if (!values.length) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = '';
                select.appendChild(option);
                return;
            }

            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });

            if (values.includes(previous)) {
                select.value = previous;
            }
        }

        function addLookupValue(label, values, storageKey, refreshCallback) {
            const value = (prompt(`Enter ${label}`) || '').trim();
            if (!value || values.includes(value)) {
                return;
            }

            values.push(value);
            values.sort((a, b) => a.localeCompare(b));
            saveList(storageKey, values);
            refreshCallback();
        }

        function removeLookupValue(label, values, storageKey, refreshCallback) {
            const value = (prompt(`Remove ${label}`) || '').trim();
            if (!value) {
                return;
            }

            const next = values.filter(item => item.toLowerCase() !== value.toLowerCase());
            replaceList(values, next);

            saveList(storageKey, values);
            refreshCallback();
        }

        function clearLookupValues(label, values, storageKey, refreshCallback) {
            if (!confirm(`Clear all ${label} values?`)) {
                return;
            }

            replaceList(values, []);
            saveList(storageKey, values);
            refreshCallback();
        }

        function replaceList(target, source) {
            target.splice(0, target.length);
            source.forEach(value => target.push(value));
        }

        function loadList(storageKey, fallback) {
            const raw = localStorage.getItem(storageKey);
            if (!raw) {
                return [...fallback];
            }

            try {
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed)) {
                    return [...fallback];
                }

                const sanitized = parsed
                    .map(value => typeof value === 'string' ? value.trim() : '')
                    .filter(value => !!value);
                return sanitized;
            } catch {
                return [...fallback];
            }
        }

        function saveList(storageKey, values) {
            localStorage.setItem(storageKey, JSON.stringify(values));
        }

        function onOk() {
            const content = composeOutput();
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'protocolViewer:done',
                    content
                }, '*');
                setStatus('Protocol content sent to editor.');
                return;
            }

            navigator.clipboard.writeText(content)
                .then(() => setStatus('Protocol content copied to clipboard.'))
                .catch(() => setStatus('Protocol content ready. Copy from page source if needed.'));
        }

        function onCancel() {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'protocolViewer:cancel'
                }, '*');
            }

            setStatus('Cancelled.');
        }

        function composeOutput() {
            const lines = [];
            appendHeader(lines);
            appendCpapInfo(lines);
            appendProtocolItems(lines);
            return lines.join('\n').trim();
        }

        function appendHeader(lines) {
            lines.push(documentModel.text || 'Protocol');
            lines.push(`Technician: ${techSelect.value || ''}`);
            lines.push(`Date of Study: ${formatStudyDate(studyDateInput.value)}`);
            lines.push(`Patient Name: ${patientNameInput.value || ''}`);
            lines.push('Technician Documentation');
            lines.push('');
        }

        function appendCpapInfo(lines) {
            const cpapLines = [];
            if (document.getElementById('cpapNoUnit').checked) {
                cpapLines.push('Pt does not have a CPAP/BiPAP unit.');
            }
            if (document.getElementById('cpapNoBring').checked) {
                cpapLines.push('Pt has machine but did not bring it.');
            }
            if (document.getElementById('cpapHasMachine').checked) {
                cpapLines.push('Pt has and brought a CPAP/BiPAP.');
            }

            if (maskStyleSelect.value && maskSizeSelect.value) {
                cpapLines.push(`Mask Style: ${maskStyleSelect.value} Mask Size: ${maskSizeSelect.value}.`);
            } else if (maskStyleSelect.value) {
                cpapLines.push(`Mask Style: ${maskStyleSelect.value}.`);
            }

            if (document.getElementById('cpapHeatedHumidity').checked) {
                cpapLines.push('Heated Humidity was used.');
            }
            if (document.getElementById('cpapChinStrap').checked) {
                cpapLines.push('A chin strap was used.');
            }

            lines.push('CPAP/BIPAP Info:');
            if (!cpapLines.length) {
                lines.push('None.');
            } else {
                cpapLines.forEach(line => lines.push(line));
            }

            if (document.getElementById('arrivedOnO2').checked) {
                lines.push('The patient arrived on O2.');
            }
            lines.push('');
        }

        function appendProtocolItems(lines) {
            documentModel.sections.forEach(section => {
                const sectionLines = [];
                (section.children || []).forEach(node => appendNodeIfChecked(sectionLines, node, 0));
                if (!sectionLines.length) {
                    return;
                }

                lines.push(section.text || 'Section');
                sectionLines.forEach(line => lines.push(line));
                lines.push('');
            });
        }

        function appendNodeIfChecked(lines, node, depth) {
            if (checkedNodeIds.has(node.id)) {
                const prefix = ' '.repeat(depth * 2);
                lines.push(`${prefix}${buildOutputText(node)}`);
            }

            (node.children || []).forEach(child => appendNodeIfChecked(lines, child, depth + 1));
        }

        function buildOutputText(node) {
            const parts = [node.text || ''];
            const subText = subTextSelections.get(node.id) || '';
            if (subText) {
                parts.push(subText);
            }
            if (node.linkText) {
                parts.push(node.linkText);
            }

            return parts.filter(part => !!part).join(' ').trim();
        }

        function toDateInputValue(rawValue) {
            const parsed = new Date(rawValue);
            if (Number.isNaN(parsed.getTime())) {
                return new Date().toISOString().substring(0, 10);
            }

            return parsed.toISOString().substring(0, 10);
        }

        function formatStudyDate(value) {
            if (!value) {
                return '';
            }

            const parsed = new Date(value);
            if (Number.isNaN(parsed.getTime())) {
                return value;
            }

            return `${parsed.getMonth() + 1}/${parsed.getDate()}/${parsed.getFullYear()}`;
        }

        function setStatus(message) {
            statusEl.textContent = message;
        }
    })();
</script>
}
