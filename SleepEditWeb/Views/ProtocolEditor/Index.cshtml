@using SleepEditWeb.Models
@model ProtocolEditorViewModel
@{
    ViewData["Title"] = "Protocol Editor";
}

@Html.AntiForgeryToken()

<div class="page-header d-flex flex-wrap justify-content-between align-items-center gap-2">
    <div>
        <h1 class="page-title">Protocol Editor</h1>
        <p class="page-subtitle">Build, organize, and export protocol statements.</p>
    </div>
    <div class="d-flex flex-wrap gap-2">
        <button type="button" id="addSectionBtn" class="btn btn-outline-primary">Add Section</button>
        <button type="button" id="addChildBtn" class="btn btn-outline-primary">Add Child</button>
        <button type="button" id="removeNodeBtn" class="btn btn-outline-danger">Remove</button>
        <button type="button" id="undoBtn" class="btn btn-outline-secondary">Undo</button>
        <button type="button" id="redoBtn" class="btn btn-outline-secondary">Redo</button>
        <button type="button" id="resetBtn" class="btn btn-outline-secondary">Reset</button>
        <button type="button" id="toggleAllSectionsBtn" class="btn btn-outline-secondary">Collapse Sections</button>
        <button type="button" id="importXmlBtn" class="btn btn-outline-primary">Import Protocol</button>
        <button type="button" id="saveXmlBtn" class="btn btn-outline-primary">Save Protocol</button>
        <button type="button" id="setDefaultProtocolBtn" class="btn btn-outline-primary">Set As Default</button>
        <button type="button" id="exportXmlBtn" class="btn btn-primary">Export Protocol</button>
    </div>
</div>
<input id="importXmlFileInput" type="file" accept=".xml,text/xml,application/xml" class="d-none" />

<div class="row g-3 protocol-editor-shell">
    <div class="col-12 col-xl-4">
        <div class="dashboard-card h-100">
            <div class="dashboard-card-header">
                <i class="bi bi-diagram-3 me-2"></i>Protocol Tree
            </div>
            <div class="dashboard-card-body">
                <div id="protocolTree" class="protocol-tree-host"></div>
            </div>
        </div>
    </div>
    <div class="col-12 col-xl-8">
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <i class="bi bi-file-earmark-text me-2"></i>Statement Info
            </div>
            <div class="dashboard-card-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="nodeTextInput" class="form-label">Statement Text</label>
                        <textarea id="nodeTextInput" class="form-control" rows="5"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-card mt-3">
            <div class="dashboard-card-header">
                <i class="bi bi-list-check me-2"></i>SubText Info
            </div>
            <div class="dashboard-card-body">
                <div class="row g-3">
                    <div class="col-12 col-lg-7">
                        <label for="subTextList" class="form-label">SubText</label>
                        <select id="subTextList" class="form-select" size="5"></select>
                    </div>
                    <div class="col-12 col-lg-5">
                        <label for="subTextInput" class="form-label">New Item</label>
                        <input id="subTextInput" type="text" class="form-control mb-2" />
                        <div class="d-flex gap-2">
                            <button type="button" id="addSubTextBtn" class="btn btn-outline-primary btn-sm">Add Item</button>
                            <button type="button" id="removeSubTextBtn" class="btn btn-outline-danger btn-sm">Remove Item</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-card mt-3">
            <div class="dashboard-card-header">
                <i class="bi bi-link-45deg me-2"></i>Link Info
            </div>
            <div class="dashboard-card-body">
                <div class="row g-3">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Statement Id</label>
                        <input id="statementIdInput" type="text" class="form-control" readonly />
                    </div>
                    <div class="col-12 col-md-4">
                        <label for="linkIdInput" class="form-label">Link Id</label>
                        <input id="linkIdInput" type="number" class="form-control" />
                    </div>
                    <div class="col-12 col-md-4">
                        <label for="linkTextInput" class="form-label">Link Text</label>
                        <input id="linkTextInput" type="text" class="form-control" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="nodeContextMenu" class="dropdown-menu shadow-sm" style="position: fixed; display: none; z-index: 1080;">
    <button type="button" id="contextMenuSelectLinkBtn" class="dropdown-item">Select Link...</button>
    <button type="button" id="contextMenuClearLinkBtn" class="dropdown-item text-danger">Clear Link</button>
</div>

<div class="modal fade" id="linkPickerModal" tabindex="-1" aria-labelledby="linkPickerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="linkPickerModalLabel">Select Link Node</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="linkPickerSourceLabel" class="small text-muted mb-2"></div>
                <label for="linkPickerSearchInput" class="form-label">Search</label>
                <input id="linkPickerSearchInput" type="text" class="form-control mb-3 protocol-link-picker-search" placeholder="Filter by node text or id" />
                <div id="linkPickerTree" class="rounded p-2 protocol-link-picker-tree"></div>
            </div>
        </div>
    </div>
</div>

<div id="protocolEditorStatus" class="small text-muted mt-3">Ready</div>

@section Scripts {
<script type="module">
    import { initializeProtocolEditor } from '/js/protocol-editor-ui.js';

    initializeProtocolEditor({
        initialDocument: @Html.Raw(Json.Serialize(Model.InitialDocument)),
        stateUrl: '@Url.Action("State", "ProtocolEditor")',
        actionRouteTemplate: '/ProtocolEditor/${action}',
        importXmlUploadUrl: '/ProtocolEditor/ImportXmlUpload',
        saveXmlUrl: '/ProtocolEditor/SaveXml',
        setDefaultProtocolUrl: '/ProtocolEditor/SetDefaultProtocol',
        exportXmlUrl: '@Url.Action("ExportXml", "ProtocolEditor")'
    });
</script>
}
