@using SleepEditWeb.Models
@model SleepNoteEditorViewModel
@{
    ViewData["Title"] = "Sleep Note Editor";
}

@Html.AntiForgeryToken()

<div class="page-header d-flex flex-wrap justify-content-between align-items-center gap-2">
    <div>
        <h1 class="page-title">Sleep Note Editor</h1>
        <p class="page-subtitle">Document-first editing with medication tool integration</p>
    </div>
    <div class="d-flex gap-2">
        <button type="button" id="openMedToolBtn" class="btn btn-primary">
            <i class="bi bi-capsule me-1"></i>Medication Tool
        </button>
        <button type="button" id="openProtocolViewerBtn" class="btn btn-outline-primary">
            <i class="bi bi-diagram-3 me-1"></i>Protocol Viewer
        </button>
        <button type="button" id="printEditorBtn" class="btn btn-outline-secondary">
            <i class="bi bi-printer me-1"></i>Print
        </button>
        <button type="button" id="saveEditorBtn" class="btn btn-outline-secondary">
            <i class="bi bi-floppy me-1"></i>Save
        </button>
    </div>
</div>

<div class="row g-4">
    <div class="col-12 col-xl-8">
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <i class="bi bi-journal-richtext"></i>
                Sleep Note
            </div>
            <div class="dashboard-card-body">
                <div class="editor-toolbar mb-3" role="toolbar" aria-label="Text formatting toolbar">
                    <button type="button" class="btn btn-sm btn-outline-secondary format-btn" data-command="bold"><i class="bi bi-type-bold"></i></button>
                    <button type="button" class="btn btn-sm btn-outline-secondary format-btn" data-command="italic"><i class="bi bi-type-italic"></i></button>
                    <button type="button" class="btn btn-sm btn-outline-secondary format-btn" data-command="underline"><i class="bi bi-type-underline"></i></button>
                    <button type="button" class="btn btn-sm btn-outline-secondary format-btn" data-command="insertUnorderedList"><i class="bi bi-list-ul"></i></button>
                </div>

                <div id="sleepNoteEditor"
                     class="sleep-note-editor"
                     contenteditable="true"
                     spellcheck="true"
                     data-initial="@Model.InitialContent">@Model.InitialContent</div>

                <div id="editorStatus" class="small text-muted mt-3">Ready</div>
            </div>
        </div>
    </div>

    <div class="col-12 col-xl-4">
        <div class="dashboard-card h-100">
            <div class="dashboard-card-header instructions-header">
                <i class="bi bi-lightbulb"></i>
                Workflow
            </div>
            <div class="dashboard-card-body">
                <ol class="instructions-list mb-0">
                    <li>Use the editor for free typing and formatting.</li>
                    <li>Open Medication Tool and search medications.</li>
                    <li>Open Protocol Viewer to insert protocol-driven selections.</li>
                    <li>Choose insertion mode: Insert, Replace Section, or Copy.</li>
                    <li>Click Done to apply narrative and keep editing.</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="medToolModal" tabindex="-1" aria-labelledby="medToolLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="medToolLabel">
                    <i class="bi bi-capsule me-2"></i>Medication Tool
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label for="medSearchInput" class="form-label">Search Medications</label>
                        <div class="input-group">
                            <input id="medSearchInput" type="text" class="form-control" placeholder="Type 2+ characters, then Enter to add" autocomplete="off" />
                            <button id="medInfoBtn" type="button" class="btn btn-outline-info" title="Look up drug information" disabled>
                                <i class="bi bi-info-circle"></i>
                            </button>
                            <button id="addMedBtn" type="button" class="btn btn-outline-primary">Add</button>
                        </div>
                        <small class="text-muted">Commands: <code>+name</code> add unknown entry, <code>-name</code> remove, <code>cls</code> clear.</small>
                    </div>

                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="mb-0">Selected Medications</label>
                            <div class="d-flex gap-2">
                                <button id="copyMedsBtn" type="button" class="btn btn-sm btn-outline-secondary">Copy</button>
                                <button id="clearMedsBtn" type="button" class="btn btn-sm btn-outline-danger">Clear</button>
                            </div>
                        </div>
                        <textarea id="selectedMedsPreview" class="form-control" rows="4" readonly></textarea>
                    </div>

                    <div class="col-12">
                        <label for="insertionMode" class="form-label">Apply Mode</label>
                        <select id="insertionMode" class="form-select">
                            <option value="0">Insert at Cursor</option>
                            <option value="1">Replace Medications Section</option>
                            <option value="2">Copy Narrative</option>
                        </select>
                    </div>

                    <div id="unknownMedsWarning" class="col-12 d-none">
                        <div class="alert alert-warning py-2 mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="unknownMedsText"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="doneMedToolBtn" class="btn btn-primary">Done</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="drugInfoModal" tabindex="-1" aria-labelledby="drugInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="drugInfoModalLabel">
                    <i class="bi bi-capsule me-2"></i>Drug Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="drugInfoContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Looking up drug information...</p>
                </div>
            </div>
            <div class="modal-footer">
                <small class="text-muted me-auto">Source: <a href="https://open.fda.gov" target="_blank">OpenFDA</a></small>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="protocolViewerModal" tabindex="-1" aria-labelledby="protocolViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen protocol-viewer-modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="protocolViewerModalLabel">
                    <i class="bi bi-diagram-3 me-2"></i>Protocol Viewer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0 overflow-hidden">
                <iframe id="protocolViewerFrame"
                        title="Protocol Viewer"
                        class="w-100 h-100 border-0 protocol-viewer-frame"
                        loading="lazy"></iframe>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    (function() {
        const initialSelections = @Html.Raw(Json.Serialize(Model.SelectedMedications));
        const preloadedSuggestions = @Html.Raw(Json.Serialize(Model.MedicationSuggestions));
        const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

        const editor = document.getElementById('sleepNoteEditor');
        const statusEl = document.getElementById('editorStatus');
        const searchInput = document.getElementById('medSearchInput');
        const medInfoBtn = document.getElementById('medInfoBtn');
        const selectedPreview = document.getElementById('selectedMedsPreview');
        const insertionMode = document.getElementById('insertionMode');
        const unknownWarning = document.getElementById('unknownMedsWarning');
        const unknownText = document.getElementById('unknownMedsText');
        const drugInfoContent = document.getElementById('drugInfoContent');
        const drugInfoTitle = document.getElementById('drugInfoModalLabel');
        const protocolViewerFrame = document.getElementById('protocolViewerFrame');
        const protocolViewerUrl = '@Url.Action("Index", "ProtocolViewer", new { embed = 1 })';

        const medModal = new bootstrap.Modal(document.getElementById('medToolModal'));
        const drugInfoModal = new bootstrap.Modal(document.getElementById('drugInfoModal'));
        const protocolViewerModal = new bootstrap.Modal(document.getElementById('protocolViewerModal'));
        let selectedMeds = initialSelections.map(item => item.name);

        document.getElementById('openMedToolBtn').addEventListener('click', () => {
            medModal.show();
            renderSelectedMeds();
            updateInfoButtonState();
            searchInput.focus();
        });
        document.getElementById('openProtocolViewerBtn').addEventListener('click', openProtocolViewer);

        document.getElementById('saveEditorBtn').addEventListener('click', saveEditorContent);
        document.getElementById('printEditorBtn').addEventListener('click', printEditorContent);
        medInfoBtn.addEventListener('click', showDrugInformation);
        window.addEventListener('message', onProtocolViewerMessage);

        document.querySelectorAll('.format-btn').forEach(button => {
            button.addEventListener('click', () => {
                document.execCommand(button.dataset.command, false, null);
                editor.focus();
            });
        });

        setupAutocomplete();

        searchInput.addEventListener('keydown', event => {
            if (event.key === 'Enter') {
                const widget = $(searchInput).autocomplete('widget');
                if (widget.is(':visible')) {
                    return;
                }
                event.preventDefault();
                addMedication(searchInput.value);
            }
        });

        document.getElementById('addMedBtn').addEventListener('click', () => addMedication(searchInput.value));
        document.getElementById('clearMedsBtn').addEventListener('click', clearMedications);
        document.getElementById('copyMedsBtn').addEventListener('click', copySelectedMedications);
        document.getElementById('doneMedToolBtn').addEventListener('click', applyMedicationTool);
        searchInput.addEventListener('input', updateInfoButtonState);

        editor.addEventListener('input', debounce(() => {
            setStatus('Unsaved changes');
        }, 400));

        window.addEventListener('beforeunload', () => {
            try {
                fetch('@Url.Action("Save", "SleepNoteEditor")', {
                    method: 'POST',
                    keepalive: true,
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': antiForgeryToken
                    },
                    body: JSON.stringify({ content: getEditorText() })
                });
            } catch {
                // Best-effort save during navigation.
            }
        });

        window.SleepNoteEditor = {
            insertTextAtCursor(text) {
                insertTextAtCursor(text || '');
            },
            replaceEditorText(text) {
                setEditorText(text || '');
            },
            getText() {
                return getEditorText();
            }
        };

        renderSelectedMeds();

        function setupAutocomplete() {
            $(searchInput).autocomplete({
                minLength: 2,
                appendTo: '#medToolModal',
                source: function(request, response) {
                    const fallback = preloadedSuggestions
                        .filter(name => name.toLowerCase().startsWith(request.term.toLowerCase()))
                        .slice(0, 10);

                    $.get('@Url.Action("SearchMedications", "SleepNoteEditor")', { term: request.term })
                        .done(function(serverMatches) {
                            response(serverMatches.length ? serverMatches : fallback);
                        })
                        .fail(function() {
                            response(fallback);
                        });
                },
                select: function(event, ui) {
                    event.preventDefault();
                    if (!ui || !ui.item || !ui.item.value) {
                        return false;
                    }
                    searchInput.value = ui.item.value;
                    updateInfoButtonState();
                    return false;
                }
            });
        }

        function addMedication(rawValue) {
            const input = (rawValue || '').trim();
            if (!input) {
                return;
            }

            if (input.toLowerCase() === 'cls') {
                clearMedications();
                return;
            }

            if (input.startsWith('-')) {
                removeMedication(input.substring(1));
                return;
            }

            const normalized = input.startsWith('+') ? input.substring(1).trim() : input;
            if (!normalized) {
                return;
            }

            selectedMeds.push(normalized);
            searchInput.value = '';
            updateInfoButtonState();
            renderSelectedMeds();
        }

        function removeMedication(name) {
            const trimmed = (name || '').trim();
            if (!trimmed) {
                return;
            }

            const index = selectedMeds.findIndex(item => item.toLowerCase() === trimmed.toLowerCase());
            if (index >= 0) {
                selectedMeds.splice(index, 1);
                renderSelectedMeds();
            }
        }

        function clearMedications() {
            selectedMeds = [];
            searchInput.value = '';
            updateInfoButtonState();
            renderSelectedMeds();
        }

        function renderSelectedMeds() {
            selectedPreview.value = selectedMeds.join(', ');
            unknownWarning.classList.add('d-none');
            unknownText.textContent = '';
        }

        async function copySelectedMedications() {
            if (!selectedMeds.length) {
                return;
            }

            await navigator.clipboard.writeText(selectedMeds.join(', '));
            setStatus('Selected medications copied');
        }

        function updateInfoButtonState() {
            const value = (searchInput.value || '').trim();
            const isCommand = value.startsWith('+') || value.startsWith('-') || value.toLowerCase() === 'cls';
            medInfoBtn.disabled = value.length < 2 || isCommand;
        }

        async function showDrugInformation() {
            const drugName = (searchInput.value || '').trim();
            if (drugName.length < 2) {
                return;
            }

            drugInfoTitle.innerHTML = '<i class="bi bi-capsule me-2"></i>' + escapeHtml(drugName);
            drugInfoContent.innerHTML =
                '<div class="text-center py-4">' +
                '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>' +
                '<p class="mt-2 text-muted">Looking up drug information...</p>' +
                '</div>';

            drugInfoModal.show();

            try {
                const response = await fetch('@Url.Action("DrugInfo", "SleepNoteEditor")?name=' + encodeURIComponent(drugName));
                if (!response.ok) {
                    throw new Error('Lookup failed');
                }

                const info = await response.json();
                drugInfoContent.innerHTML = buildDrugInfoMarkup(info, drugName);
            } catch {
                drugInfoContent.innerHTML =
                    '<div class="alert alert-danger">' +
                    '<i class="bi bi-exclamation-circle me-2"></i>Failed to load drug information. Please try again.' +
                    '</div>';
            }
        }

        function buildDrugInfoMarkup(info, drugName) {
            if (!info || !info.found) {
                const errorMessage = info && info.errorMessage
                    ? escapeHtml(info.errorMessage)
                    : 'No information found for this medication.';
                return '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>' +
                    errorMessage +
                    '</div>' +
                    '<p>Try searching on <a href="https://www.drugs.com/search.php?searchterm=' + encodeURIComponent(drugName) + '" target="_blank">Drugs.com</a> or ' +
                    '<a href="https://www.google.com/search?q=' + encodeURIComponent(drugName + ' medication') + '" target="_blank">Google</a>.</p>';
            }

            let html = '<div class="drug-info">';

            if (info.genericName) {
                html += '<p class="text-muted mb-3"><strong>Generic Name:</strong> ' + escapeHtml(info.genericName) + '</p>';
            }
            if (info.manufacturer) {
                html += '<p class="text-muted mb-3"><strong>Manufacturer:</strong> ' + escapeHtml(info.manufacturer) + '</p>';
            }
            if (info.purpose) {
                html += '<div class="mb-3"><h6 class="text-primary"><i class="bi bi-bullseye me-1"></i>Purpose</h6><p>' + escapeHtml(info.purpose) + '</p></div>';
            }
            if (info.uses) {
                html += '<div class="mb-3"><h6 class="text-success"><i class="bi bi-check-circle me-1"></i>Uses</h6><p>' + escapeHtml(info.uses) + '</p></div>';
            }
            if (info.warnings) {
                html += '<div class="mb-3"><h6 class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Warnings</h6><p class="small">' + escapeHtml(info.warnings) + '</p></div>';
            }
            if (info.dosage) {
                html += '<div class="mb-3"><h6 class="text-info"><i class="bi bi-clock me-1"></i>Dosage</h6><p>' + escapeHtml(info.dosage) + '</p></div>';
            }

            html += '</div>';
            return html;
        }

        async function applyMedicationTool() {
            const payload = {
                editorContent: getEditorText(),
                selectedMedications: selectedMeds,
                mode: Number(insertionMode.value),
                cursorIndex: getCursorOffset(editor)
            };

            const response = await fetch('@Url.Action("Complete", "SleepNoteEditor")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                setStatus('Unable to apply medication tool');
                return;
            }

            const result = await response.json();

            if (result.mode === 2 && result.copyText) {
                await navigator.clipboard.writeText(result.copyText);
                setStatus('Narrative copied to clipboard');
            } else {
                setEditorText(result.content || getEditorText());
                setStatus('Medication narrative applied');
            }

            selectedMeds = (result.selectedMedications || []).map(item => item.name);
            renderSelectedMeds();

            if (result.unknownMedications && result.unknownMedications.length) {
                unknownText.textContent = 'Unknown medications marked: ' + result.unknownMedications.join(', ');
                unknownWarning.classList.remove('d-none');
            }

            medModal.hide();
            await saveEditorContent();
        }

        async function saveEditorContent() {
            const response = await fetch('@Url.Action("Save", "SleepNoteEditor")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify({ content: getEditorText() })
            });

            setStatus(response.ok ? 'Saved' : 'Save failed');
        }

        function getEditorText() {
            return editor.innerText || '';
        }

        function setEditorText(value) {
            editor.innerText = value || '';
        }

        function insertTextAtCursor(text) {
            const selection = window.getSelection();
            if (!selection || !selection.rangeCount) {
                editor.innerText += text;
                return;
            }

            const range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(document.createTextNode(text));
            range.collapse(false);
            selection.removeAllRanges();
            selection.addRange(range);
        }

        function setStatus(message) {
            statusEl.textContent = message;
        }

        function printEditorContent() {
            const editorText = getEditorText();
            const printableWindow = window.open('', '_blank', 'width=900,height=700');
            if (!printableWindow) {
                setStatus('Unable to open print window');
                return;
            }

            const escapedContent = escapeHtml(editorText);
            const title = 'Sleep Note';

            printableWindow.document.write(`<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>${title}</title>
    <style>
        body { font-family: Segoe UI, Arial, sans-serif; margin: 24px; color: #111; }
        h1 { font-size: 20px; margin-bottom: 16px; }
        pre { white-space: pre-wrap; word-break: break-word; font-size: 14px; line-height: 1.5; }
    </style>
</head>
<body>
    <h1>${title}</h1>
    <pre>${escapedContent}</pre>
</body>
</html>`);
            printableWindow.document.close();
            printableWindow.focus();
            printableWindow.print();
            printableWindow.close();
            setStatus('Print dialog opened');
        }

        function openProtocolViewer() {
            protocolViewerFrame.src = protocolViewerUrl;
            protocolViewerModal.show();
        }

        async function onProtocolViewerMessage(event) {
            if (event.origin !== window.location.origin) {
                return;
            }

            const data = event.data || {};
            if (data.type === 'protocolViewer:cancel') {
                protocolViewerModal.hide();
                return;
            }

            if (data.type !== 'protocolViewer:done' || typeof data.content !== 'string') {
                return;
            }

            insertTextAtCursor((data.content || '') + '\n');
            protocolViewerModal.hide();
            await saveEditorContent();
            setStatus('Protocol content inserted');
        }

        function debounce(callback, wait) {
            let timeoutId;
            return (...args) => {
                window.clearTimeout(timeoutId);
                timeoutId = window.setTimeout(() => callback(...args), wait);
            };
        }

        function getCursorOffset(element) {
            const selection = window.getSelection();
            if (!selection || !selection.rangeCount) {
                return getEditorText().length;
            }

            const range = selection.getRangeAt(0).cloneRange();
            range.selectNodeContents(element);
            range.setEnd(selection.focusNode, selection.focusOffset);
            return range.toString().length;
        }

        function escapeHtml(value) {
            return (value || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }
    })();
</script>
}
