@using System.Collections.Immutable
@model ImmutableArray<string>
@{
    ViewData["Title"] = "Medication List";
    var selectedMeds = ViewBag.SelectedMeds as ImmutableArray<string>? ?? [];
}

@Html.AntiForgeryToken()

<div class="page-header">
    <h1 class="page-title">Medication List</h1>
    <p class="page-subtitle">Search and manage your medication selections</p>
</div>

<div class="row g-4">
    <!-- Main Form Section -->
    <div class="col-12 col-xl-8">
        <div class="dashboard-card h-100">
            <div class="dashboard-card-header">
                <i class="bi bi-search"></i>
                Select a Medication
            </div>
            <div class="dashboard-card-body">
                <form id="medForm">
                    <label for="filter" class="form-label">Search Medications</label>
                    <div class="input-group">
                        <input type="text" 
                               id="filter" 
                               name="selectedMed" 
                               class="form-control form-control-lg"
                               placeholder="Type to search medications... (press Enter to add)"
                               autocomplete="off"
                               autofocus>
                        <button type="button" id="infoBtn" class="btn btn-outline-info btn-lg" title="Look up drug information" disabled>
                            <i class="bi bi-info-circle"></i>
                        </button>
                    </div>
                </form>

                <div id="selectedMedsSection" class="selected-meds-section mt-4 @(selectedMeds.Length == 0 ? "d-none" : "")">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="selected-meds-label mb-0">
                            <i class="bi bi-clipboard-check me-2"></i>Selected Medications (<span id="medCount">@selectedMeds.Length</span>):
                        </label>
                        <div class="d-flex gap-3">
                            <button type="button" id="copyBtn" class="btn btn-outline-secondary" title="Copy to clipboard">
                                <i class="bi bi-copy me-1"></i>Copy
                            </button>
                            <button type="button" id="clearBtn" class="btn btn-outline-danger" title="Clear all selections">
                                <i class="bi bi-trash me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                    <textarea readonly id="selectedMedsText" class="form-control" rows="4">@string.Join(", ", selectedMeds)</textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions Section -->
    <div class="col-12 col-xl-4">
        <div class="dashboard-card h-100">
            <div class="dashboard-card-header instructions-header">
                <i class="bi bi-info-circle"></i>
                Quick Reference
            </div>
            <div class="dashboard-card-body">
                <ul class="instructions-list mb-0">
                    <li>Type at least <strong>2 characters</strong> to see suggestions</li>
                    <li>Press <strong>Enter</strong> to add medication</li>
                    <li>Add new medication: <code>+MedicationName</code></li>
                    <li>Remove medication: <code>-MedicationName</code></li>
                    <li>Clear all selections: <code>cls</code></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Drug Info Modal -->
<div class="modal fade" id="drugInfoModal" tabindex="-1" aria-labelledby="drugInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="drugInfoModalLabel">
                    <i class="bi bi-capsule me-2"></i>Drug Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="drugInfoContent">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Looking up drug information...</p>
                </div>
            </div>
            <div class="modal-footer">
                <small class="text-muted me-auto">Source: <a href="https://open.fda.gov" target="_blank">OpenFDA</a></small>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var meds = @Html.Raw(Json.Serialize(Model));
            
            var antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();
            
            $('#filter').autocomplete({
                source: function (request, response) {
                    var term = request.term.toLowerCase();
                    var results = meds.filter(function (med) {
                        return med.toLowerCase().startsWith(term);
                    });
                    response(results.slice(0, 10));
                },
                minLength: 2,
                
                select: function(event, ui) {
                    event.preventDefault();
                    $('#filter').val(ui.item.value);
                    $('#filter').autocomplete('close');
                    // Submission will happen via keydown Enter handler
                    return false;
                }
            });

            $('#filter').on('keydown', function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    submitMedication();
                }
            });

            

            function submitMedication() {
                
                var inputVal = $('#filter').val().trim();
                
                // Silently ignore if input is empty (can happen after successful submission clears the field)
                if (inputVal.length === 0) {
                    return;
                }
                
                if (inputVal.length < 2) {
                    $('#filter').focus();
                    return;
                }

                $.ajax({
                    url: '@Url.Action("AddMedication", "MedList")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ selectedMed: inputVal }),
                    headers: {
                        'RequestVerificationToken': antiForgeryToken
                    },
                    success: function(response) {
                        if (response.success) {
                            // Update selected medications display
                            if (response.selectedMeds && response.selectedMeds.length > 0) {
                                $('#selectedMedsText').val(response.selectedMeds.join(', '));
                                $('#medCount').text(response.selectedMeds.length);
                                $('#selectedMedsSection').removeClass('d-none');
                            } else {
                                $('#selectedMedsSection').addClass('d-none');
                                $('#selectedMedsText').val('');
                                $('#medCount').text('0');
                            }
                            
                            // Update autocomplete source if med list changed
                            if (response.medList) {
                                meds = response.medList;
                            }
                            
                            // Clear and refocus input
                            $('#filter').val('').focus();
                        }
                    },
                    error: function() {
                        console.error('An error occurred while adding medication.');
                    }
                });
            }

            $('#filter').focus();

            // Clear selections functionality
            $('#clearBtn').click(function() {
                $('#filter').val('cls');
                submitMedication();
            });

            // Copy to clipboard functionality
            $('#copyBtn').click(function() {
                var text = $('#selectedMedsText').val();
                if (text) {
                    navigator.clipboard.writeText(text).then(function() {
                        var btn = $('#copyBtn');
                        var originalHtml = btn.html();
                        btn.html('<i class="bi bi-check me-1"></i>Copied!');
                        btn.removeClass('btn-outline-secondary').addClass('btn-success');
                        setTimeout(function() {
                            btn.html(originalHtml);
                            btn.removeClass('btn-success').addClass('btn-outline-secondary');
                        }, 2000);
                    }).catch(function() {
                        showMessage('Failed to copy to clipboard', false);
                    });
                }
            });

            // Enable/disable info button based on input
            $('#filter').on('input', function() {
                var val = $(this).val().trim();
                // Disable if empty or starts with +/- (add/remove commands)
                var isCommand = val.startsWith('+') || val.startsWith('-');
                $('#infoBtn').prop('disabled', val.length < 2 || isCommand);
            });

            // Drug info lookup
            $('#infoBtn').click(function() {
                var drugName = $('#filter').val().trim();
                if (drugName.length < 2) return;

                var modal = new bootstrap.Modal(document.getElementById('drugInfoModal'));
                $('#drugInfoModalLabel').html('<i class="bi bi-capsule me-2"></i>' + drugName);
                $('#drugInfoContent').html(
                    '<div class="text-center py-4">' +
                    '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>' +
                    '<p class="mt-2 text-muted">Looking up drug information...</p></div>'
                );
                modal.show();

                $.ajax({
                    url: '@Url.Action("DrugInfo", "MedList")',
                    type: 'GET',
                    data: { name: drugName },
                    success: function(info) {
                        var html = '';
                        if (info.found) {
                            html = '<div class="drug-info">';
                            if (info.genericName) {
                                html += '<p class="text-muted mb-3"><strong>Generic Name:</strong> ' + info.genericName + '</p>';
                            }
                            if (info.manufacturer) {
                                html += '<p class="text-muted mb-3"><strong>Manufacturer:</strong> ' + info.manufacturer + '</p>';
                            }
                            if (info.purpose) {
                                html += '<div class="mb-3"><h6 class="text-primary"><i class="bi bi-bullseye me-1"></i>Purpose</h6><p>' + info.purpose + '</p></div>';
                            }
                            if (info.uses) {
                                html += '<div class="mb-3"><h6 class="text-success"><i class="bi bi-check-circle me-1"></i>Uses</h6><p>' + info.uses + '</p></div>';
                            }
                            if (info.warnings) {
                                html += '<div class="mb-3"><h6 class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Warnings</h6><p class="small">' + info.warnings + '</p></div>';
                            }
                            if (info.dosage) {
                                html += '<div class="mb-3"><h6 class="text-info"><i class="bi bi-clock me-1"></i>Dosage</h6><p>' + info.dosage + '</p></div>';
                            }
                            html += '</div>';
                        } else {
                            html = '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>' + 
                                   (info.errorMessage || 'No information found for this medication.') + '</div>' +
                                   '<p>Try searching on <a href="https://www.drugs.com/search.php?searchterm=' + encodeURIComponent(drugName) + '" target="_blank">Drugs.com</a> or ' +
                                   '<a href="https://www.google.com/search?q=' + encodeURIComponent(drugName + ' medication') + '" target="_blank">Google</a>.</p>';
                        }
                        $('#drugInfoContent').html(html);
                    },
                    error: function() {
                        $('#drugInfoContent').html(
                            '<div class="alert alert-danger"><i class="bi bi-exclamation-circle me-2"></i>Failed to load drug information. Please try again.</div>'
                        );
                    }
                });
            });
        });
    </script>
}
