@model List<string>
@{
    ViewData["Title"] = "Medication List";
    var selectedMeds = ViewBag.SelectedMeds as List<string>;
}

<div class="page-header">
    <h1 class="page-title">Medication List</h1>
    <p class="page-subtitle">Search and manage your medication selections</p>
</div>

<div class="row">
    <!-- Main Form Section -->
    <div class="col-lg-8 mb-4">
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <i class="bi bi-search"></i>
                Select a Medication
            </div>
            <div class="dashboard-card-body">
                @if (ViewBag.Message != null)
                {
                    <div class="alert alert-success" role="alert">
                        <i class="bi bi-check-circle me-2"></i>@ViewBag.Message
                    </div>
                }
                
                <form asp-action="Index" method="post">
                    <div class="mb-3">
                        <label for="filter" class="form-label">Search Medications</label>
                        <input type="text" 
                               id="filter" 
                               name="selectedMed" 
                               class="form-control form-control-lg"
                               placeholder="Type to search medications..."
                               autocomplete="off"
                               autofocus>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-plus-circle me-2"></i>Submit
                        </button>
                    </div>
                </form>

                @if (selectedMeds != null && selectedMeds.Count > 0)
                {
                    <div class="selected-meds-section">
                        <label class="selected-meds-label">
                            <i class="bi bi-clipboard-check me-2"></i>Selected Medications:
                        </label>
                        <textarea readonly class="form-control" rows="3">@string.Join(", ", selectedMeds)</textarea>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Instructions Section -->
    <div class="col-lg-4">
        <div class="dashboard-card">
            <div class="dashboard-card-header instructions-header">
                <i class="bi bi-info-circle"></i>
                Instructions
            </div>
            <div class="dashboard-card-body">
                <ul class="instructions-list">
                    <li>Type at least <strong>two characters</strong> to see suggestions.</li>
                    <li>Select a medication by:
                        <ul>
                            <li>Clicking a suggestion</li>
                            <li>Pressing <strong>Enter</strong></li>
                            <li>Clicking <strong>Submit</strong></li>
                        </ul>
                    </li>
                    <li>Add a new medication: <code>+MedicationName</code></li>
                    <li>Remove a medication: <code>-MedicationName</code></li>
                    <li>Clear selections: type <code>cls</code></li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var meds = @Html.Raw(Json.Serialize(Model));
            var isAutocompleteOpen = false;
            
            $('#filter').autocomplete({
                source: function (request, response) {
                    var term = request.term.toLowerCase();
                    var results = meds.filter(function (med) {
                        return med.toLowerCase().startsWith(term);
                    });
                    response(results.slice(0, 10));
                },
                minLength: 2,
                open: function() {
                    isAutocompleteOpen = true;
                },
                close: function() {
                    isAutocompleteOpen = false;
                },
                select: function(event, ui) {
                    $('#filter').val(ui.item.value);
                    setTimeout(function() {
                        $('form').submit();
                    }, 50);
                    return false;
                }
            });

            $('#filter').on('keydown', function (e) {
                if (e.which === 13) {
                    if (isAutocompleteOpen) {
                        return;
                    }
                    e.preventDefault();
                    var inputVal = $('#filter').val();
                    if (inputVal.length >= 2) {
                        $('form').submit();
                    } else {
                        alert('Please enter at least two characters.');
                    }
                }
            });

            $('form').on('submit', function (e) {
                var inputVal = $('#filter').val();
                if (inputVal.length < 2) {
                    e.preventDefault();
                    alert('Please enter at least two characters.');
                    $('#filter').focus();
                    return false;
                }
            });

            $('#filter').focus();
        });
    </script>
}
