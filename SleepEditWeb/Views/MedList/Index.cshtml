@model List<string>
@{
    ViewData["Title"] = "Medication List";
    var selectedMeds = ViewBag.SelectedMeds as List<string> ?? new List<string>();
}

@Html.AntiForgeryToken()

<div class="page-header">
    <h1 class="page-title">Medication List</h1>
    <p class="page-subtitle">Search and manage your medication selections</p>
</div>

<div class="row g-4">
    <!-- Main Form Section -->
    <div class="col-12 col-xl-8">
        <div class="dashboard-card h-100">
            <div class="dashboard-card-header">
                <i class="bi bi-search"></i>
                Select a Medication
            </div>
            <div class="dashboard-card-body">
                <div id="messageAlert" class="alert alert-success d-none" role="alert">
                    <i class="bi bi-check-circle me-2"></i><span id="messageText"></span>
                </div>
                
                <form id="medForm">
                    <label for="filter" class="form-label">Search Medications</label>
                    <input type="text" 
                           id="filter" 
                           name="selectedMed" 
                           class="form-control form-control-lg"
                           placeholder="Type to search medications... (press Enter to add)"
                           autocomplete="off"
                           autofocus>
                </form>

                <div id="selectedMedsSection" class="selected-meds-section mt-4 @(selectedMeds.Count == 0 ? "d-none" : "")">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="selected-meds-label mb-0">
                            <i class="bi bi-clipboard-check me-2"></i>Selected Medications (<span id="medCount">@selectedMeds.Count</span>):
                        </label>
                        <button type="button" id="copyBtn" class="btn btn-outline-secondary btn-sm" title="Copy to clipboard">
                            <i class="bi bi-copy me-1"></i>Copy
                        </button>
                    </div>
                    <textarea readonly id="selectedMedsText" class="form-control" rows="4">@string.Join(", ", selectedMeds)</textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions Section -->
    <div class="col-12 col-xl-4">
        <div class="dashboard-card h-100">
            <div class="dashboard-card-header instructions-header">
                <i class="bi bi-info-circle"></i>
                Quick Reference
            </div>
            <div class="dashboard-card-body">
                <ul class="instructions-list mb-0">
                    <li>Type at least <strong>2 characters</strong> to see suggestions</li>
                    <li>Press <strong>Enter</strong> to add medication</li>
                    <li>Add new medication: <code>+MedicationName</code></li>
                    <li>Remove medication: <code>-MedicationName</code></li>
                    <li>Clear all selections: <code>cls</code></li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var meds = @Html.Raw(Json.Serialize(Model));
            var isAutocompleteOpen = false;
            var antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();
            
            $('#filter').autocomplete({
                source: function (request, response) {
                    var term = request.term.toLowerCase();
                    var results = meds.filter(function (med) {
                        return med.toLowerCase().startsWith(term);
                    });
                    response(results.slice(0, 10));
                },
                minLength: 2,
                open: function() {
                    isAutocompleteOpen = true;
                },
                close: function() {
                    isAutocompleteOpen = false;
                },
                select: function(event, ui) {
                    $('#filter').val(ui.item.value);
                    setTimeout(function() {
                        submitMedication();
                    }, 50);
                    return false;
                }
            });

            $('#filter').on('keydown', function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    if (isAutocompleteOpen) {
                        return;
                    }
                    submitMedication();
                }
            });

            $('#medForm').on('submit', function (e) {
                e.preventDefault();
                submitMedication();
            });

            function submitMedication() {
                var inputVal = $('#filter').val().trim();
                
                // Silently ignore if input is empty (can happen after successful submission clears the field)
                if (inputVal.length === 0) {
                    return;
                }
                
                if (inputVal.length < 2) {
                    showMessage('Please enter at least two characters.', false);
                    $('#filter').focus();
                    return;
                }

                $.ajax({
                    url: '@Url.Action("AddMedication", "MedList")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ selectedMed: inputVal }),
                    headers: {
                        'RequestVerificationToken': antiForgeryToken
                    },
                    success: function(response) {
                        showMessage(response.message, response.success);
                        
                        if (response.success) {
                            // Update selected medications display
                            if (response.selectedMeds && response.selectedMeds.length > 0) {
                                $('#selectedMedsText').val(response.selectedMeds.join(', '));
                                $('#medCount').text(response.selectedMeds.length);
                                $('#selectedMedsSection').removeClass('d-none');
                            } else {
                                $('#selectedMedsSection').addClass('d-none');
                                $('#selectedMedsText').val('');
                                $('#medCount').text('0');
                            }
                            
                            // Update autocomplete source if med list changed
                            if (response.medList) {
                                meds = response.medList;
                            }
                            
                            // Clear and refocus input
                            $('#filter').val('').focus();
                        }
                    },
                    error: function() {
                        showMessage('An error occurred. Please try again.', false);
                    }
                });
            }

            function showMessage(message, success) {
                var alert = $('#messageAlert');
                alert.removeClass('d-none alert-success alert-danger')
                     .addClass(success ? 'alert-success' : 'alert-danger');
                $('#messageText').text(message);
                
                // Auto-hide after 3 seconds
                setTimeout(function() {
                    alert.addClass('d-none');
                }, 3000);
            }

            $('#filter').focus();

            // Copy to clipboard functionality
            $('#copyBtn').click(function() {
                var text = $('#selectedMedsText').val();
                if (text) {
                    navigator.clipboard.writeText(text).then(function() {
                        var btn = $('#copyBtn');
                        var originalHtml = btn.html();
                        btn.html('<i class="bi bi-check me-1"></i>Copied!');
                        btn.removeClass('btn-outline-secondary').addClass('btn-success');
                        setTimeout(function() {
                            btn.html(originalHtml);
                            btn.removeClass('btn-success').addClass('btn-outline-secondary');
                        }, 2000);
                    }).catch(function() {
                        showMessage('Failed to copy to clipboard', false);
                    });
                }
            });
        });
    </script>
}
